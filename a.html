<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مشغل فيديو احترافي - منصة أثر</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
            --highlight-color: #0ea5e9;
            --highlight-light: #38bdf8;
            --highlight-dark: #0284c7;
            --border-radius: 24px;
        }

        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        @keyframes progressWave { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
        @keyframes shimmer { 0%{left:-100%} 100%{left:100%} }
        @keyframes ripple { 0%{opacity:0.8;transform:scale(0)} 100%{opacity:0;transform:scale(2)} }
        @keyframes ambientPulse { 0%,100%{opacity:0.1;transform:scale(1)} 50%{opacity:0.2;transform:scale(1.1)} }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
        @keyframes morph { 0%,100%{border-radius:50%} 50%{border-radius:42% 58% 70% 30% / 45% 45% 55% 55%} }

        *{box-sizing:border-box;margin:0;padding:0}
        html{font-size:16px;scroll-behavior:smooth}
        body{
            font-family:'Inter', -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
            background:linear-gradient(135deg,#e0f2fe 0%,#bae6fd 50%,#fdf2f8 100%);
            background-size:400% 400%;
            min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
            transition:background 0.8s ease;
        }

        .container{max-width:1200px;width:100%}

        /* Video Container */
        .video-container{
            position:relative;overflow:hidden;border-radius:var(--border-radius);
            background:linear-gradient(145deg,rgba(255,255,255,0.15),rgba(255,255,255,0.05));
            backdrop-filter:blur(40px) saturate(200%) brightness(110%);
            -webkit-backdrop-filter:blur(40px) saturate(200%) brightness(110%);
            border:1px solid rgba(255,255,255,0.25);
            box-shadow:0 20px 60px rgba(0,0,0,0.15),inset 0 2px 4px rgba(255,255,255,0.5);
            transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);
            will-change:transform;
        }

        .video-container::before{
            content:'';position:absolute;inset:-80px;
            background:radial-gradient(circle at 50% 50%,var(--highlight-color) 0%,transparent 60%);
            opacity:0.15;filter:blur(80px);z-index:-1;
            animation:ambientPulse 4s ease-in-out infinite;pointer-events:none;
        }

        .video-container:hover{
            transform:translateY(-8px) scale(1.01);
            border-color:rgba(255,255,255,0.4);
            box-shadow:0 30px 80px rgba(0,0,0,0.2),0 0 60px var(--highlight-color),inset 0 2px 6px rgba(255,255,255,0.6);
        }

        .video-container video{width:100%;height:auto;min-height:300px;display:block;background:#000}

        .video-loading{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            width:72px;height:72px;border-radius:50%;display:none;z-index:15;
        }
        .video-loading.active{display:block}
        .video-loading::before{
            content:"";position:absolute;inset:0;border-radius:50%;
            background:conic-gradient(from 0deg,rgba(255,255,255,0.05) 0 30%,var(--highlight-color) 30% 60%,rgba(255,255,255,0.05) 60% 100%);
            -webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 8px),#000 0);
            animation:spin 1s linear infinite;
            box-shadow:0 8px 25px var(--highlight-color);
        }

        .video-error{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            color:#fff;text-align:center;z-index:15;display:none;
            background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);
            padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);
        }
        .video-error.active{display:block;animation:fadeIn 0.3s ease}
        .video-error button{
            background:var(--highlight-color);border:none;color:#fff;padding:10px 24px;
            border-radius:20px;margin-top:10px;cursor:pointer;transition:all 0.2s ease;
        }

        .quality-indicator{
            position:absolute;top:1rem;right:1rem;
            background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);
            color:#22c55e;padding:6px 12px;border-radius:20px;font-size:0.85rem;
            font-weight:600;display:none;z-index:20;box-shadow:0 4px 15px rgba(0,0,0,0.3);
        }
        .quality-indicator.active{display:block}

        .resume-prompt{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);padding:2rem;
            border-radius:1rem;border:1px solid rgba(255,255,255,0.2);text-align:center;
            z-index:100;animation:fadeIn 0.3s ease;
        }
        .resume-prompt p{color:#fff;font-size:1.1rem;margin-bottom:1.5rem}
        .resume-prompt button{
            background:var(--highlight-color);border:none;color:#fff;padding:10px 24px;
            border-radius:24px;margin:0 8px;cursor:pointer;font-size:1rem;
            transition:all 0.3s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .resume-prompt button:hover{transform:scale(1.05);box-shadow:0 8px 20px var(--highlight-color)}
        .resume-prompt button:last-child{background:rgba(255,255,255,0.2)}

        .thumbnail-preview{
            position:absolute;bottom:120%;left:50%;transform:translateX(-50%);
            background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);padding:8px;
            border-radius:12px;display:none;pointer-events:none;z-index:30;
            box-shadow:0 8px 32px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);
        }
        .thumbnail-preview.active{display:block}
        .thumbnail-preview img{width:160px;height:90px;border-radius:8px}
        .thumbnail-time{color:#fff;text-align:center;font-size:12px;margin-top:6px;font-weight:600}

        .seek-overlay{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            font-size:3rem;color:#fff;pointer-events:none;opacity:0;
            transition:opacity 0.25s ease;text-shadow:0 0 20px var(--highlight-color);z-index:20;
        }
        .seek-overlay.active{opacity:1}

        .controls-container{
            position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);
            width:95%;padding:1rem 1.5rem;
            background:linear-gradient(145deg,rgba(255,255,255,0.18),rgba(255,255,255,0.08));
            backdrop-filter:blur(60px) saturate(180%) brightness(110%);
            -webkit-backdrop-filter:blur(60px) saturate(180%) brightness(110%);
            border-radius:2rem;border:1px solid rgba(255,255,255,0.3);
            box-shadow:0 12px 40px rgba(31,38,135,0.4),inset 0 2px 6px rgba(255,255,255,0.4);
            transition:all 0.4s ease;opacity:0;z-index:21;
        }
        .video-container:hover .controls-container,
        .video-container.paused .controls-container,
        .video-container.show-controls .controls-container{opacity:1}

        .progress-bar-container{
            width:100%;height:6px;background:rgba(255,255,255,0.2);
            border-radius:10px;cursor:pointer;position:relative;direction:ltr !important;
            margin-bottom:1rem;overflow:hidden;box-shadow:inset 0 2px 8px rgba(0,0,0,0.15);
        }
        .buffered-bar{position:absolute;top:0;left:0;height:100%;background:rgba(255,255,255,0.35);border-radius:10px;width:0%}
        .progress-bar{
            height:100%;position:relative;width:0%;border-radius:10px;
            background:linear-gradient(90deg,var(--highlight-color),var(--highlight-light),var(--highlight-color));
            background-size:300% 100%;animation:progressWave 3s ease-in-out infinite;
            box-shadow:0 0 20px var(--highlight-color);overflow:hidden;
        }
        .progress-bar::before{
            content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,0.6),transparent);
            animation:shimmer 2.5s infinite;
        }
        .progress-bar::after{
            content:"";position:absolute;right:-8px;top:50%;transform:translateY(-50%);
            width:16px;height:16px;background:radial-gradient(circle at 30% 30%,#fff,var(--highlight-color));
            border-radius:50%;box-shadow:0 0 0 4px rgba(255,255,255,0.3),0 4px 16px var(--highlight-color);
            transition:all 0.3s ease;
        }
        .progress-bar-container:hover .progress-bar::after{transform:translateY(-50%) scale(1.4)}

        .control-btn{
            background:linear-gradient(145deg,rgba(255,255,255,0.3),rgba(255,255,255,0.1));
            backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.3);
            color:#fff;font-size:1rem;cursor:pointer;width:2.75rem;height:2.75rem;
            border-radius:50%;display:flex;align-items:center;justify-content:center;
            position:relative;overflow:hidden;
            box-shadow:0 8px 24px rgba(0,0,0,0.15),inset 0 2px 6px rgba(255,255,255,0.4);
            transition:all 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .control-btn::before{
            content:'';position:absolute;top:15%;left:25%;width:35%;height:35%;
            background:radial-gradient(circle,rgba(255,255,255,0.7),transparent);
            border-radius:50%;filter:blur(4px);pointer-events:none;
        }
        .control-btn::after{
            content:'';position:absolute;inset:0;border-radius:50%;
            background:radial-gradient(circle,var(--highlight-color) 0%,transparent 70%);
            opacity:0;transition:opacity 0.3s ease;pointer-events:none;
        }
        .control-btn:hover{
            background:linear-gradient(145deg,rgba(255,255,255,0.4),rgba(255,255,255,0.15));
            transform:translateY(-4px) scale(1.12);
            box-shadow:0 12px 32px rgba(0,0,0,0.2),0 0 40px var(--highlight-color);
            animation:float 2s ease-in-out infinite;
        }
        .control-btn:hover::after{opacity:0.3;animation:ripple 1.5s ease-out infinite}
        .control-btn:active{transform:translateY(-2px) scale(1.05)}

        #playPauseBtn{width:3.5rem;height:3.5rem;animation:float 3s ease-in-out infinite}
        #playPauseBtn:hover{animation:float 1.5s ease-in-out infinite,morph 3s ease-in-out infinite}

        .volume-slider{
            -webkit-appearance:none;width:90px;height:6px;
            background:linear-gradient(to right,var(--highlight-color) 50%,rgba(255,255,255,0.25) 50%);
            border-radius:10px;outline:none;cursor:pointer;direction:ltr !important;
            box-shadow:inset 0 2px 6px rgba(0,0,0,0.15);transition:all 0.2s ease;
        }
        .volume-slider:hover{height:8px}
        .volume-slider::-webkit-slider-thumb{
            -webkit-appearance:none;width:16px;height:16px;
            background:radial-gradient(circle at 30% 30%,#fff,var(--highlight-color));
            border-radius:50%;cursor:pointer;
            box-shadow:0 0 0 4px rgba(255,255,255,0.3),0 4px 12px var(--highlight-color);
            transition:all 0.3s ease;
        }
        .volume-slider::-webkit-slider-thumb:hover{transform:scale(1.3)}

        .speed-controls{
            position:absolute;bottom:3.5rem;right:-1rem;
            background:rgba(0,0,0,0.95);backdrop-filter:blur(30px);
            border-radius:1rem;padding:.5rem;display:none;flex-direction:column;gap:.35rem;
            width:110px;border:1px solid rgba(255,255,255,0.2);z-index:100;
            box-shadow:0 12px 40px rgba(0,0,0,0.5);
        }
        .speed-controls button{
            color:#fff;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
            padding:.5rem;border-radius:.75rem;cursor:pointer;text-align:center;
            transition:all 0.3s ease;
        }
        .speed-controls button:hover,.speed-controls button.active{
            background:linear-gradient(135deg,var(--highlight-color),var(--highlight-light));
            transform:scale(1.05);box-shadow:0 4px 15px var(--highlight-color);
        }

        .time-display{
            font-family:'Courier New',monospace;font-variant-numeric:tabular-nums;
            font-size:.95rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.5);
        }
        .controls-center{
            display:flex;justify-content:center;align-items:center;width:33.333%;
            background:rgba(0,0,0,0.35);backdrop-filter:blur(10px);
            border:1px solid rgba(255,255,255,0.2);padding:.4rem .8rem;
            border-radius:1rem;gap:.4rem;box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .controls-left,.controls-right{display:flex;align-items:center;gap:1rem;width:33.333%}
        .controls-left{justify-content:flex-start}
        .controls-right{justify-content:flex-end}

        @media (max-width:768px){
            .controls-container{width:98%;padding:.65rem 1rem}
            .control-btn{width:2.25rem;height:2.25rem}
            #playPauseBtn{width:3rem;height:3rem}
            .volume-slider{width:70px}
        }
    </style>
</head>
<body>
    <canvas id="thumbnailCanvas" style="display:none" width="160" height="90"></canvas>
    <canvas id="colorCanvas" style="display:none" width="100" height="100"></canvas>

    <div class="container">
        <div id="videoPlayer" class="video-container">
            <video id="video" crossOrigin="anonymous" preload="metadata">
                <!-- يتم تحديد المصدر عبر JavaScript -->
            </video>

            <div id="videoLoading" class="video-loading"></div>
            <div id="videoError" class="video-error">
                <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:10px;"></i>
                <p id="errorMessage">حدث خطأ في تحميل الفيديو</p>
                <p id="retryMessage" style="font-size:0.9rem;margin-top:8px;opacity:0.8"></p>
                <button onclick="retryVideo()">إعادة المحاولة</button>
            </div>

            <div id="qualityIndicator" class="quality-indicator"></div>
            <div id="seekOverlay" class="seek-overlay"></div>

            <div class="controls-container">
                <div class="progress-bar-container" id="progressBarContainer">
                    <div class="buffered-bar" id="bufferedBar"></div>
                    <div class="progress-bar" id="progressBar"></div>
                    <div id="thumbnailPreview" class="thumbnail-preview">
                        <img id="thumbnailImg" src="" alt="Preview" />
                        <div class="thumbnail-time" id="thumbnailTime">00:00</div>
                    </div>
                </div>

                <div style="display:flex;align-items:center;justify-content:space-between;color:#fff;">
                    <div class="controls-left">
                        <button id="playPauseBtn" class="control-btn"><i class="fas fa-play"></i></button>
                        <div style="display:flex;align-items:center;gap:.5rem;">
                            <button id="volumeBtn" class="control-btn"><i class="fas fa-volume-up"></i></button>
                            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="1" />
                        </div>
                    </div>

                    <div class="controls-center">
                        <span id="currentTime" class="time-display">00:00</span>
                        <span>/</span>
                        <span id="duration" class="time-display">--:--</span>
                    </div>

                    <div class="controls-right">
                        <div style="position:relative">
                            <button id="settingsBtn" class="control-btn"><i class="fas fa-cog"></i></button>
                            <div id="speedControls" class="speed-controls">
                                <button data-speed="0.5">0.5x</button>
                                <button data-speed="0.75">0.75x</button>
                                <button data-speed="1" class="active">عادي</button>
                                <button data-speed="1.25">1.25x</button>
                                <button data-speed="1.5">1.5x</button>
                                <button data-speed="2">2x</button>
                            </div>
                        </div>
                        <button id="pipBtn" class="control-btn" style="display:none"><i class="fas fa-external-link-alt"></i></button>
                        <button id="fullscreenBtn" class="control-btn"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // =========================
    // تعيين رابط الفيديو هنا
    // =========================
    const VIDEO_URL = 'https://archive.org/download/20251005_20251005_1020/%D9%84%D8%BA%D8%A9_%D8%A7%D9%84%D8%A3%D8%B9%D9%85%D8%A7%D9%84__%D9%85%D9%82%D8%AF%D9%85%D8%A9_%D9%84%D9%84%D9%85%D8%AD%D8%A7%D8%B3%D8%A8%D8%A9.mp4';
    
    (function() {
        'use strict';

        const videoPlayer = document.getElementById('videoPlayer');
        const video = document.getElementById('video');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const bufferedBar = document.getElementById('bufferedBar');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const speedControls = document.getElementById('speedControls');
        const seekOverlay = document.getElementById('seekOverlay');
        const videoLoading = document.getElementById('videoLoading');
        const videoError = document.getElementById('videoError');
        const errorMessage = document.getElementById('errorMessage');
        const retryMessage = document.getElementById('retryMessage');
        const pipBtn = document.getElementById('pipBtn');
        const qualityIndicator = document.getElementById('qualityIndicator');
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        const thumbnailImg = document.getElementById('thumbnailImg');
        const thumbnailTime = document.getElementById('thumbnailTime');
        const thumbnailCanvas = document.getElementById('thumbnailCanvas');
        const thumbnailCtx = thumbnailCanvas.getContext('2d');
        const colorCanvas = document.getElementById('colorCanvas');
        const colorCtx = colorCanvas.getContext('2d');

        let isDragging = false;
        let wasPlayingBeforeSeeking = false;
        let animationFrameId = null;
        let retryCount = 0;
        const maxRetries = 3;
        let retryTimeout = null;
        let controlsTimeout = null;
        let thumbnailCache = {};
        let lastBufferCheck = Date.now();
        let lastBufferedBytes = 0;
        const videoId = getVideoId(VIDEO_URL);

        function init() {
            // تحميل الفيديو
            video.src = VIDEO_URL;
            video.load();
            
            loadSavedSettings();
            setupEventListeners();
            if (document.pictureInPictureEnabled) pipBtn.style.display = 'flex';
        }

        // ===== Dynamic Color Extraction =====
        function extractDominantColor() {
            try {
                colorCtx.drawImage(video, 0, 0, 100, 100);
                const imageData = colorCtx.getImageData(0, 0, 100, 100);
                const data = imageData.data;
                
                let r = 0, g = 0, b = 0;
                const pixels = data.length / 4;
                
                for (let i = 0; i < data.length; i += 4) {
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                }
                
                r = Math.floor(r / pixels);
                g = Math.floor(g / pixels);
                b = Math.floor(b / pixels);
                
                applyDynamicColors(r, g, b);
            } catch(e) {}
        }

        function applyDynamicColors(r, g, b) {
            const color = `rgb(${r}, ${g}, ${b})`;
            const lighter = `rgb(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)})`;
            const darker = `rgb(${Math.max(0, r - 40)}, ${Math.max(0, g - 40)}, ${Math.max(0, b - 40)})`;
            
            document.documentElement.style.setProperty('--highlight-color', color);
            document.documentElement.style.setProperty('--highlight-light', lighter);
            document.documentElement.style.setProperty('--highlight-dark', darker);
            
            document.body.style.background = `
                radial-gradient(circle at 20% 50%, rgba(${r}, ${g}, ${b}, 0.15), transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(${r + 50}, ${g + 50}, ${b + 50}, 0.1), transparent 50%),
                linear-gradient(135deg, #e0f2fe, #bae6fd, #fdf2f8)
            `;
        }

        video.addEventListener('play', () => {
            const colorInterval = setInterval(() => {
                if (!video.paused) extractDominantColor();
                else clearInterval(colorInterval);
            }, 3000);
        });

        // ===== Performance: RAF =====
        function updateProgress() {
            if (!isDragging && !video.paused && !video.ended) {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeEl.textContent = formatTime(video.currentTime);
                animationFrameId = requestAnimationFrame(updateProgress);
            }
        }

        // ===== Error Recovery =====
        function handleVideoError(e) {
            const error = video.error;
            let msg = 'حدث خطأ في تحميل الفيديو';
            
            if (error) {
                switch(error.code) {
                    case 1: msg = 'تم إلغاء التحميل'; break;
                    case 2: msg = 'خطأ في الشبكة'; break;
                    case 3: msg = 'خطأ في فك التشفير'; break;
                    case 4: msg = 'الفيديو غير مدعوم'; break;
                }
            }
            
            errorMessage.textContent = msg;
            
            if (retryCount < maxRetries) {
                retryCount++;
                const delay = 2000 * retryCount;
                retryMessage.textContent = `إعادة المحاولة ${retryCount}/${maxRetries} خلال ${delay/1000} ثانية...`;
                
                clearTimeout(retryTimeout);
                retryTimeout = setTimeout(() => {
                    const currentTime = video.currentTime;
                    video.load();
                    video.currentTime = currentTime;
                    video.play().catch(() => {});
                }, delay);
            } else {
                retryMessage.textContent = 'فشلت جميع المحاولات';
                showError();
            }
        }

        window.retryVideo = function() {
            retryCount = 0;
            hideError();
            video.load();
            video.play().catch(() => {});
        };

        // ===== Watch History =====
        function checkForResume() {
            const savedTime = localStorage.getItem(`video_${videoId}_time`);
            const savedDuration = localStorage.getItem(`video_${videoId}_duration`);
            
            if (savedTime && savedDuration && Math.abs(savedDuration - video.duration) < 1) {
                const resumeTime = parseFloat(savedTime);
                if (video.duration - resumeTime > 30) {
                    showResumePrompt(resumeTime);
                }
            }
        }

        function showResumePrompt(time) {
            const prompt = document.createElement('div');
            prompt.className = 'resume-prompt';
            prompt.innerHTML = `
                <p>هل تريد المتابعة من ${formatTime(time)}؟</p>
                <button onclick="resumeFromSaved(${time})">نعم</button>
                <button onclick="startFromBeginning()">من البداية</button>
            `;
            videoPlayer.appendChild(prompt);
        }

        window.resumeFromSaved = function(time) {
            video.currentTime = time;
            document.querySelector('.resume-prompt')?.remove();
            video.play();
        };

        window.startFromBeginning = function() {
            document.querySelector('.resume-prompt')?.remove();
            video.currentTime = 0;
            video.play();
        };

        function saveWatchPosition() {
            if (!video.paused && video.currentTime > 5) {
                localStorage.setItem(`video_${videoId}_time`, video.currentTime);
                localStorage.setItem(`video_${videoId}_duration`, video.duration);
            }
        }

        setInterval(saveWatchPosition, 5000);

        video.addEventListener('ended', () => {
            localStorage.removeItem(`video_${videoId}_time`);
            localStorage.removeItem(`video_${videoId}_duration`);
        });

        // ===== Network Quality =====
        video.addEventListener('progress', () => {
            const now = Date.now();
            if (now - lastBufferCheck > 2000 && video.buffered.length > 0) {
                try {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const currentBytes = bufferedEnd * 1024 * 100;
                    const timeDiff = (now - lastBufferCheck) / 1000;
                    const speed = (currentBytes - lastBufferedBytes) / timeDiff / 1024;
                    
                    let quality = 'ممتاز';
                    let color = '#22c55e';
                    
                    if (speed < 100) {
                        quality = 'ضعيف';
                        color = '#ef4444';
                    } else if (speed < 500) {
                        quality = 'متوسط';
                        color = '#f59e0b';
                    }
                    
                    if (speed > 0) {
                        qualityIndicator.textContent = `${quality} (${Math.round(speed)} KB/s)`;
                        qualityIndicator.style.color = color;
                        qualityIndicator.classList.add('active');
                        
                        setTimeout(() => qualityIndicator.classList.remove('active'), 3000);
                    }
                    
                    lastBufferedBytes = currentBytes;
                    lastBufferCheck = now;
                } catch(e) {}
            }
        });

        // ===== Thumbnails =====
        progressBarContainer.addEventListener('mousemove', (e) => {
            if (!video.duration) return;
            
            const rect = progressBarContainer.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            const time = Math.max(0, Math.min(video.duration, percent * video.duration));
            const timeKey = Math.floor(time / 5) * 5;
            
            thumbnailPreview.style.left = `${percent * 100}%`;
            thumbnailTime.textContent = formatTime(time);
            
            if (thumbnailCache[timeKey]) {
                thumbnailImg.src = thumbnailCache[timeKey];
                thumbnailPreview.classList.add('active');
            } else {
                generateThumbnail(time, timeKey);
            }
        });

        progressBarContainer.addEventListener('mouseleave', () => {
            thumbnailPreview.classList.remove('active');
        });

        function generateThumbnail(time, cacheKey) {
            const tempVideo = document.createElement('video');
            tempVideo.src = VIDEO_URL;
            tempVideo.currentTime = time;
            tempVideo.muted = true;
            tempVideo.crossOrigin = 'anonymous';
            
            tempVideo.addEventListener('seeked', () => {
                try {
                    thumbnailCtx.drawImage(tempVideo, 0, 0, 160, 90);
                    const dataUrl = thumbnailCanvas.toDataURL();
                    thumbnailCache[cacheKey] = dataUrl;
                    thumbnailImg.src = dataUrl;
                    thumbnailPreview.classList.add('active');
                } catch(e) {}
                tempVideo.remove();
            }, { once: true });
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            video.addEventListener('loadstart', showLoading);
            video.addEventListener('waiting', showLoading);
            video.addEventListener('canplay', () => {
                hideLoading();
                retryCount = 0;
                hideError();
            });
            video.addEventListener('error', handleVideoError);

            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                videoPlayer.classList.remove('paused');
                cancelAnimationFrame(animationFrameId);
                updateProgress();
            });

            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                videoPlayer.classList.add('paused');
                cancelAnimationFrame(animationFrameId);
            });

            playPauseBtn.addEventListener('click', () => {
                video.paused ? video.play() : video.pause();
            });

            video.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(video.duration);
                videoPlayer.classList.add('paused');
                checkForResume();
            });

            video.addEventListener('timeupdate', () => {
                if (isDragging) return;
                currentTimeEl.textContent = formatTime(video.currentTime);
            });

            video.addEventListener('progress', () => {
                try {
                    if (video.buffered.length > 0 && video.duration > 0) {
                        const end = video.buffered.end(video.buffered.length - 1);
                        bufferedBar.style.width = `${(end / video.duration) * 100}%`;
                    }
                } catch {}
            });

            let isMouseDown = false;
            function handleSeek(e) {
                const rect = progressBarContainer.getBoundingClientRect();
                const seekPercent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const newTime = seekPercent * video.duration;
                if (!isNaN(newTime)) {
                    video.currentTime = newTime;
                    progressBar.style.width = `${seekPercent * 100}%`;
                }
            }

            progressBarContainer.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                isDragging = true;
                wasPlayingBeforeSeeking = !video.paused;
                video.pause();
                handleSeek(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isMouseDown) handleSeek(e);
            });

            document.addEventListener('mouseup', () => {
                if (isMouseDown) {
                    isMouseDown = false;
                    isDragging = false;
                    if (wasPlayingBeforeSeeking) video.play();
                }
            });

            volumeSlider.addEventListener('input', () => {
                video.volume = volumeSlider.value;
                updateVolumeIcon();
                updateVolumeSliderBg();
                localStorage.setItem('videoVolume', video.volume);
            });

            volumeBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                volumeSlider.value = video.muted ? 0 : (localStorage.getItem('videoVolume') || 1);
                updateVolumeIcon();
                updateVolumeSliderBg();
            });

            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    videoPlayer.requestFullscreen?.();
                } else {
                    document.exitFullscreen?.();
                }
            });

            document.addEventListener('fullscreenchange', () => {
                const isFs = document.fullscreenElement;
                fullscreenBtn.innerHTML = isFs ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
            });

            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                speedControls.style.display = speedControls.style.display === 'flex' ? 'none' : 'flex';
            });

            speedControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const speed = parseFloat(e.target.dataset.speed);
                    video.playbackRate = speed;
                    speedControls.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    speedControls.style.display = 'none';
                    localStorage.setItem('videoSpeed', speed);
                }
            });

            pipBtn.addEventListener('click', async () => {
                try {
                    if (document.pictureInPictureElement) {
                        await document.exitPictureInPicture();
                    } else {
                        await video.requestPictureInPicture();
                    }
                } catch {}
            });

            document.addEventListener('click', () => {
                speedControls.style.display = 'none';
            });

            videoPlayer.addEventListener('mousemove', showControls);

            document.addEventListener('visibilitychange', () => {
                if (document.hidden && !video.paused) {
                    video.pause();
                    sessionStorage.setItem('wasPlayingBeforeHidden', 'true');
                } else if (sessionStorage.getItem('wasPlayingBeforeHidden') === 'true') {
                    video.play();
                    sessionStorage.removeItem('wasPlayingBeforeHidden');
                }
            });
        }

        // ===== Utilities =====
        function formatTime(seconds) {
            if (isNaN(seconds) || !isFinite(seconds)) return '--:--';
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hrs > 0) return `${hrs}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            return `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        }

        function getVideoId(url) {
            const match = url.match(/\/download\/([^\/]+)/);
            return match ? match[1] : 'video_' + Date.now();
        }

        function updateVolumeIcon() {
            const v = video.volume;
            if (video.muted || v === 0) {
                volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else if (v < 0.5) {
                volumeBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
            } else {
                volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        }

        function updateVolumeSliderBg() {
            const percent = video.volume * 100;
            volumeSlider.style.background = `linear-gradient(to right, var(--highlight-color) ${percent}%, rgba(255,255,255,0.25) ${percent}%)`;
        }

        function showLoading() { videoLoading.classList.add('active'); }
        function hideLoading() { videoLoading.classList.remove('active'); }
        function showError() { videoError.classList.add('active'); }
        function hideError() { videoError.classList.remove('active'); }

        function showControls() {
            videoPlayer.classList.add('show-controls');
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                if (!video.paused) videoPlayer.classList.remove('show-controls');
            }, 3000);
        }

        function loadSavedSettings() {
            const savedVolume = localStorage.getItem('videoVolume');
            if (savedVolume !== null) {
                video.volume = parseFloat(savedVolume);
                volumeSlider.value = savedVolume;
            }

            const savedSpeed = localStorage.getItem('videoSpeed');
            if (savedSpeed) {
                video.playbackRate = parseFloat(savedSpeed);
                speedControls.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.speed === savedSpeed);
                });
            }

            updateVolumeIcon();
            updateVolumeSliderBg();
        }

        init();
    })();
    </script>
</body>
</html>
